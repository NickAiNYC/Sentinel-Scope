# Sentinel Vision-to-Compliance Bridge

> Bridge between Sentinel-Scope vision system and ConComplyAi compliance database

## Overview

The Vision-to-Compliance Bridge integrates Sentinel-Scope's computer vision capabilities with ConComplyAi's compliance tracking to automatically detect and alert on compliance gaps in real-time from site camera feeds.

## Features

✅ **VisionAgent**: Processes site-cam frames to detect Workers and Equipment  
✅ **EntityMatcher**: Queries ConComplyAi database for compliance status  
✅ **Compliance Gap Detection**: Identifies issues like expired insurance or missing certifications  
✅ **OutreachAgent**: Automatically notifies supervisors of compliance gaps  
✅ **DecisionProof**: Generates immutable audit trail with screenshots and timestamps  

## Architecture

```
Site Camera Frame → VisionAgent → Entity Detection
                                        ↓
                    EntityMatcher → Query ConComplyAi DB
                                        ↓
                    Gap Detection → Identify Compliance Issues
                                        ↓
                    OutreachAgent → Notify Supervisor
                                        ↓
                    DecisionProof → Audit Trail (Screenshot + Timestamp)
```

## Quick Start

### Basic Usage

```python
from packages.sentinel import VisionComplianceBridge

# Initialize the bridge
bridge = VisionComplianceBridge(
    vision_api_key="your-deepseek-api-key",
    supervisor_contact="supervisor@example.com"
)

# Process a frame
proofs = bridge.process_frame(
    frame_source="path/to/site-cam-frame.jpg",
    screenshot_url="https://storage.example.com/frame-001.jpg",
    location="Zone A"
)

# Generate audit report
report = bridge.generate_audit_report()
print(f"Total Detections: {report['total_detections']}")
print(f"Gaps Detected: {report['gaps_detected']}")
```

### Custom Database Integration

```python
from packages.sentinel import EntityMatcher

class ConComplyAiDatabase:
    """Your ConComplyAi database interface."""
    
    def query_compliance_status(self, entity_id: str, entity_type: str):
        # Query your database
        return {
            'entity_id': entity_id,
            'entity_type': entity_type,
            'is_compliant': True,
            'insurance_status': 'Active',
            'certification_status': 'Valid',
            'last_updated': datetime.now(),
            'compliance_notes': 'All requirements met'
        }

# Use custom database
entity_matcher = EntityMatcher(database_interface=ConComplyAiDatabase())
```

### Custom Notification Service

```python
from packages.sentinel import OutreachAgent

class EmailNotificationService:
    """Your email notification service."""
    
    def send_notification(self, recipient: str, subject: str, message: str):
        # Send email via SMTP, SendGrid, AWS SES, etc.
        return True

# Use custom notification
outreach = OutreachAgent(
    notification_service=EmailNotificationService(),
    supervisor_contact="supervisor@example.com"
)
```

## Components

### 1. VisionAgent

Processes site-cam frames using AI vision models to detect Workers and Equipment.

```python
from packages.sentinel import VisionAgent

agent = VisionAgent(api_key="your-api-key")
entities = agent.process_frame(
    frame_source="frame.jpg",
    location="Zone A"
)

for entity in entities:
    print(f"{entity.entity_type}: {entity.name} (confidence: {entity.confidence:.2%})")
```

### 2. EntityMatcher

Queries ConComplyAi database and detects compliance gaps.

```python
from packages.sentinel import EntityMatcher

matcher = EntityMatcher()

# Check compliance for a single entity
compliance_status = matcher.check_compliance(entity)

# Detect gaps
gap = matcher.detect_gaps(entity, compliance_status)
if gap:
    print(f"Gap detected: {gap.gap_type} ({gap.severity})")
```

### 3. OutreachAgent

Sends notifications to supervisors when gaps are detected.

```python
from packages.sentinel import OutreachAgent

outreach = OutreachAgent(supervisor_contact="supervisor@example.com")

# Notify single gap
outreach.notify_gap(gap)

# Notify multiple gaps
results = outreach.notify_multiple_gaps(gaps)
print(f"Sent {results['successful']} notifications")

# Send summary
outreach.send_summary_notification(gaps)
```

### 4. DecisionProof

Immutable audit trail for all detections.

```python
# DecisionProofs are automatically generated by VisionComplianceBridge
proofs = bridge.get_all_proofs()

for proof in proofs:
    print(f"Proof ID: {proof.proof_id}")
    print(f"Entity: {proof.entity.name}")
    print(f"Screenshot: {proof.screenshot_url}")
    print(f"Timestamp: {proof.timestamp}")
    if proof.gap:
        print(f"Gap: {proof.gap.gap_type} ({proof.gap.severity})")
```

## Data Models

### DetectedEntity
- `entity_id`: Unique identifier
- `entity_type`: "Worker" or "Equipment"
- `name`: Entity name/identifier
- `confidence`: Detection confidence (0-1)
- `location`: Where detected
- `frame_timestamp`: When detected

### ComplianceStatus
- `entity_id`: Entity identifier
- `is_compliant`: Overall compliance status
- `insurance_status`: "Active", "Expired", "Pending"
- `certification_status`: "Valid", "Expired", "None"
- `insurance_expiry`: Expiration date
- `compliance_notes`: Additional notes

### ComplianceGap
- `gap_id`: Unique identifier
- `entity`: DetectedEntity
- `compliance_status`: ComplianceStatus
- `gap_type`: Type of gap (e.g., "Insurance Expired")
- `severity`: "Critical", "High", "Medium", "Low"
- `description`: Human-readable description

### DecisionProof (Immutable)
- `proof_id`: Unique identifier
- `entity`: DetectedEntity
- `compliance_status`: ComplianceStatus (if checked)
- `gap`: ComplianceGap (if detected)
- `screenshot_url`: URL/path to screenshot
- `timestamp`: Proof creation time
- `notification_sent`: Whether notification was triggered

## Gap Detection Logic

The EntityMatcher detects the following compliance gaps:

| Gap Type | Condition | Severity |
|----------|-----------|----------|
| Insurance Expired | `insurance_status == "Expired"` | Critical |
| Insurance Pending | `insurance_status == "Pending"` | High |
| Certification Expired | `certification_status == "Expired"` | High |
| Certification Missing | `certification_status == "None"` | Medium |

## Integration Points

### ConComplyAi Database
Replace `MockDatabaseInterface` with your actual database implementation:

```python
class ConComplyAiDatabase:
    def query_compliance_status(self, entity_id: str, entity_type: str):
        # Connect to your database
        # Query compliance data
        # Return dict with compliance information
        pass
```

### Notification Service
Replace `MockNotificationService` with your notification system:

```python
class YourNotificationService:
    def send_notification(self, recipient: str, subject: str, message: str):
        # Send via email, SMS, Slack, etc.
        return success_boolean
```

## Testing

Run the test suite:

```bash
python -m pytest tests/test_vision_compliance.py -v
```

Test coverage includes:
- Model validation
- Entity detection
- Compliance checking
- Gap detection
- Notification triggering
- DecisionProof generation
- End-to-end integration

## Examples

See `examples/vision_compliance_example.py` for complete usage examples.

## Dependencies

- `pydantic>=2.12.5` - Data validation
- `instructor>=1.0.0` - Structured AI outputs
- AI model provider (DeepSeek, OpenAI, etc.)

## License

MIT License - See LICENSE file for details.

## Support

For issues or questions:
- GitHub Issues: https://github.com/NickAiNYC/Sentinel-Scope/issues
- Documentation: See `/docs` directory

---

**Built for NYC Construction Compliance**  
*Sentinel-Scope x ConComplyAi Integration*
